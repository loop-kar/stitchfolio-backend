# Deploy backend + nginx to production on push/merge to main
# Uses /stitchfolio/env/.prod.env and docker-compose (backend + nginx).

name: Deploy Main

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  SSH_HOST: "31.97.202.6"
  SSH_USER: "root"
  DEPLOY_PATH: "/stitchfolio/backend-prod"
  ENV_FILE: "/stitchfolio/env/.prod.env"
  CONFIG_FILE: "prod.yaml"
  NGINX_HOST_PORT: "80"
  COMPOSE_PROJECT: "stitchfolio-prod"
  BRANCH: "main"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            BRANCH="${{ env.BRANCH }}"
            REPO_URL="git@github.com:${{ github.repository }}.git"

            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "Deploy path not found. Creating and cloning..."
              mkdir -p /stitchfolio
              git clone "$REPO_URL" "$DEPLOY_PATH"
              cd "$DEPLOY_PATH"
              git checkout "$BRANCH"
            else
              cd "$DEPLOY_PATH"
            fi

            echo "Pulling latest from $BRANCH..."
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git pull origin "$BRANCH"

            echo "Writing .env for compose..."
            echo "ENV_FILE_PATH=${{ env.ENV_FILE }}" > .env
            echo "CONFIG_FILE=${{ env.CONFIG_FILE }}" >> .env
            echo "NGINX_HOST_PORT=${{ env.NGINX_HOST_PORT }}" >> .env

            echo "Building and starting with Docker Compose..."
            docker compose -p ${{ env.COMPOSE_PROJECT }} build --no-cache

            echo "Running migrations..."
            docker compose -p ${{ env.COMPOSE_PROJECT }} run --rm backend \
              ./app --configFile ./config/${{ env.CONFIG_FILE }} --migrate true

            echo "Starting backend + nginx..."
            docker compose -p ${{ env.COMPOSE_PROJECT }} up -d

            echo "Production deployment complete."
